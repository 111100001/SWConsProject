<div dir="rtl">

## FunctionDef update_prediction_data
**update_prediction_data**: وظيفة `update_prediction_data` هي جلب بيانات التوقعات وكتابتها في قاعدة بيانات Cassandra.

**parameters**: هذه الوظيفة لا تأخذ أي معاملات مباشرة.

**Code Description**: 
تقوم هذه الوظيفة بتنفيذ الخطوات التالية:

1. تستدعي الوظيفة `_min_daily_pageviews_by_sr` للحصول على قاموس يربط بين أسماء subreddits (`sr_name`) وأقل عدد من المشاهدات اليومية (`min_pageviews`) خلال عدد محدد من الأيام (`NDAYS_TO_QUERY`). يتم تخزين النتيجة في المتغير `min_daily_by_sr`.

2. يتم معالجة القيم الخاصة بصفحة الواجهة الأمامية (front page) حيث يتم دمج القيم في حالة وجود اسم subreddit فارغ (`''`). يتم استخدام القيمة الافتراضية لـ `DefaultSR.name` (بعد تحويلها إلى أحرف صغيرة) كاسم لصفحة الواجهة الأمامية. يتم جمع القيم معًا وحذف المفتاح الفارغ من القاموس.

3. يتم تصفية القاموس `min_daily_by_sr` لاستبعاد أي subreddits لديها أقل من 100 مشاهدة يومية. يتم تخزين النتائج المصفاة في المتغير `filtered`.

4. أخيرًا، يتم تخزين البيانات المصفاة في قاعدة بيانات Cassandra باستخدام الوظيفة `PromoMetrics.set` مع المفتاح `MIN_DAILY_CASS_KEY`.

**Note**: 
- يتم استخدام هذه الوظيفة لجلب بيانات المشاهدات اليومية لكل subreddit وتحديد أقل عدد من المشاهدات اليومية خلال فترة زمنية محددة. يتم بعد ذلك تصفية النتائج لاستبعاد subreddits التي لديها عدد قليل جدًا من المشاهدات (أقل من 100 مشاهدة يومية) قبل تخزينها في قاعدة البيانات.
- يتم دمج قيم صفحة الواجهة الأمامية في حالة وجود اسم subreddit فارغ (`''`) لضمان دقة البيانات.
## FunctionDef _min_daily_pageviews_by_sr(ndays, end_date)
**_min_daily_pageviews_by_sr**: وظيفة `_min_daily_pageviews_by_sr` هي إرجاع قاموس يربط بين اسم subreddit (`sr_name`) وأقل عدد من المشاهدات اليومية (`min_pageviews`) خلال عدد محدد من الأيام (`ndays`).

**parameters**: معاملات هذه الوظيفة.
· `ndays`: عدد الأيام التي سيتم حساب أقل عدد من المشاهدات اليومية خلالها. القيمة الافتراضية هي `NDAYS_TO_QUERY`.
· `end_date`: التاريخ النهائي الذي سيتم حساب المشاهدات حتى ذلك التاريخ. إذا لم يتم تحديده، سيتم استخدام تاريخ آخر تعديل لبيانات الزيارات (`traffic.get_traffic_last_modified`) مطروحًا منه يوم واحد.

**Code Description**: 
تقوم هذه الوظيفة بحساب أقل عدد من المشاهدات اليومية لكل subreddit خلال فترة زمنية محددة. يتم ذلك من خلال الاستعلام عن قاعدة البيانات للحصول على عدد المشاهدات اليومية لكل subreddit خلال الفترة المحددة. يتم استخدام الاستعلام التالي:

1. يتم تحديد الفترة الزمنية (`start` و `stop`) بناءً على `end_date` وعدد الأيام (`ndays`).
2. يتم الحصول على نقاط زمنية (`time_points`) لكل يوم في الفترة المحددة باستخدام `traffic.get_time_points`.
3. يتم تنفيذ استعلام على جدول `PageviewsBySubredditAndPath` للحصول على أقل عدد من المشاهدات اليومية لكل subreddit خلال الفترة المحددة. يتم تصفية النتائج لاستبعاد أي سجلات لا تتوافق مع نمط `%-GET_listing`.
4. يتم تجميع النتائج في قاموس (`retval`) حيث يكون المفتاح هو اسم subreddit والقيمة هي أقل عدد من المشاهدات اليومية.

يتم استخدام هذه الوظيفة في `update_prediction_data` للحصول على أقل عدد من المشاهدات اليومية لكل subreddit، ثم يتم تصفية النتائج لاستبعاد subreddits التي لديها أقل من 100 مشاهدة يومية. يتم بعد ذلك تخزين النتائج في قاعدة بيانات Cassandra باستخدام `PromoMetrics.set`.

**Note**: 
- إذا لم يتم تحديد `end_date`، سيتم استخدام تاريخ آخر تعديل لبيانات الزيارات مطروحًا منه يوم واحد.
- يتم تصفية النتائج لاستبعاد أي سجلات لا تتوافق مع نمط `%-GET_listing`.

**Output Example**: 
مثال على القيمة المرجعة من هذه الوظيفة:
```python
{
    'lightpainting': 16,
    'photography': 45,
    'art': 120
}
```
## FunctionDef get_date_range(start, end)
Doc is waiting to be generated...
## FunctionDef get_campaigns_by_date(srs, start, end, ignore)
**get_campaigns_by_date**: وظيفة `get_campaigns_by_date` هي استرداد الحملات الإعلانية بناءً على نطاق زمني محدد وتصفية الحملات بناءً على معايير محددة.

**parameters**: معاملات هذه الوظيفة.
· `srs`: قائمة تحتوي على كائنات تمثل المنتديات (Subreddits) التي نريد البحث عن الحملات الإعلانية المرتبطة بها.
· `start`: تاريخ البداية للنطاق الزمني المطلوب البحث فيه.
· `end`: تاريخ النهاية للنطاق الزمني المطلوب البحث فيه.
· `ignore`: (اختياري) كائن يمثل حملة إعلانية معينة نريد تجاهلها في النتائج.

**Code Description**: 
تقوم هذه الوظيفة بالخطوات التالية:
1. تحويل `srs` إلى مجموعة من أسماء المنتديات (Subreddits) باستخدام `sr.name`.
2. استرداد معرفات الحملات الإعلانية (`campaign_ids`) المرتبطة بالمنتديات المحددة والنطاق الزمني باستخدام `PromotionWeights.get_campaign_ids`.
3. إذا تم توفير معامل `ignore`، يتم تجاهل الحملة الإعلانية المقابلة من النتائج.
4. استرداد تفاصيل الحملات الإعلانية باستخدام `PromoCampaign._byID` وتصفية الحملات المحذوفة.
5. جمع معرفات المعاملات (`transaction_ids`) المرتبطة بالحملات الإعلانية التي ليست من نوع `NO_TRANSACTION`.
6. إذا كانت هناك معاملات، يتم استرداد تفاصيلها باستخدام `Bid.query` وفهرستها بناءً على معرف المعاملة والحملة الإعلانية.
7. إنشاء مجموعة من التواريخ (`dates`) ضمن النطاق الزمني المحدد باستخدام `get_date_range`.
8. تصفية الحملات الإعلانية بناءً على شروط محددة مثل أن تكون المعاملة مصرح بها أو مدفوعة (`is_auth` أو `is_charged`).
9. إرجاع قاموس يحتوي على التواريخ كأساس ومجموعة من الحملات الإعلانية المرتبطة بكل تاريخ.

**العلاقة مع الوظائف الأخرى**:
- تستدعي هذه الوظيفة `get_date_range` لإنشاء نطاق زمني من التواريخ.
- يتم استدعاء هذه الوظيفة من قبل `find_campaigns` لاسترداد الحملات الإعلانية المرتبطة بمنتديات محددة وتوسيع البحث ليشمل المنتديات المستهدفة الأخرى.

**Note**:
- يجب أن تكون التواريخ المقدمة في `start` و `end` بتنسيق متوافق مع `to_date`.
- الحملات الإعلانية التي لا تحتوي على معاملات (`NO_TRANSACTION`) أو التي لديها عدد مشاهدات أقل من أو يساوي الصفر يتم تجاهلها.

**Output Example**:
```python
{
    datetime.date(2023, 10, 1): {<PromoCampaign object 1>, <PromoCampaign object 2>},
    datetime.date(2023, 10, 2): {<PromoCampaign object 3>},
    ...
}
```
## FunctionDef get_predicted_pageviews(srs, location)
**get_predicted_pageviews**: وظيفة `get_predicted_pageviews` هي حساب عدد الصفحات المتوقعة التي سيتم مشاهدتها للعناوين الممولة.

**parameters**: معاملات هذه الوظيفة.
· `srs`: قائمة تحتوي على كائنات `Subreddit` أو كائن واحد من نوع `Subreddit`. تمثل هذه الكائنات الصفحات الفرعية (subreddits) التي سيتم حساب الصفحات المتوقعة لها.
· `location`: كائن من نوع `Location` يمثل الموقع الجغرافي المستهدف. إذا لم يتم تحديده، يتم افتراض أن الحساب غير مستهدف جغرافيًا.

**Code Description**: 
تقوم هذه الوظيفة بحساب عدد الصفحات المتوقعة التي سيتم مشاهدتها للعناوين الممولة بناءً على الصفحات الفرعية (subreddits) والموقع الجغرافي المحدد. يتم حساب الصفحات المتوقعة باستخدام الصيغة التالية:

الصفحات المستهدفة جغرافيًا = (الصفحات المتوقعة غير المستهدفة) * (عامل الموقع الجغرافي)

حيث يتم حساب عامل الموقع الجغرافي (`location_factor`) بناءً على نسبة الصفحات التي تمت مشاهدتها في الموقع المحدد مقارنة بالصفحات التي تمت مشاهدتها بشكل عام. إذا لم يتم تحديد موقع جغرافي، يتم افتراض أن عامل الموقع الجغرافي هو 1.0.

بعد ذلك، يتم حساب الصفحات المتوقعة اليومية (`daily_inventory`) لكل صفحة فرعية (subreddit) باستخدام `PromoMetrics.get`. إذا كانت الصفحة الفرعية من النوع الافتراضي (`default_srids`)، يتم تطبيق عامل مخزون افتراضي (`DEFAULT_INVENTORY_FACTOR`)، وإلا يتم تطبيق عامل مخزون عادي (`INVENTORY_FACTOR`).

أخيرًا، يتم ضرب الصفحات المتوقعة اليومية بعامل المخزون وعامل الموقع الجغرافي للحصول على العدد النهائي للصفحات المتوقعة. إذا تم تمرير صفحة فرعية واحدة فقط، يتم إرجاع القيمة مباشرة، وإلا يتم إرجاع قاموس يحتوي على الصفحات المتوقعة لكل صفحة فرعية.

**Note**: 
- إذا كانت الصفحة الفرعية من النوع الافتراضي، يتم تطبيق عامل مخزون مختلف.
- إذا لم يتم تحديد موقع جغرافي، يتم افتراض أن الحساب غير مستهدف جغرافيًا.

**Output Example**: 
إذا تم تمرير صفحة فرعية واحدة مثل `Subreddit(name="funny")` وموقع جغرافي مثل `Location(country="US")`، قد يكون الإخراج كالتالي:
```
10000
```
إذا تم تمرير قائمة من الصفحات الفرعية مثل `[Subreddit(name="funny"), Subreddit(name="news")]`، قد يكون الإخراج كالتالي:
```
{"funny": 10000, "news": 8000}
```
## FunctionDef make_target_name(target)
Doc is waiting to be generated...
## FunctionDef find_campaigns(srs, start, end, ignore)
**find_campaigns**: وظيفة `find_campaigns` هي استرداد جميع الحملات الإعلانية المرتبطة بمجموعة من المنتديات (Subreddits) وتوسيع البحث ليشمل الحملات الإعلانية في المنتديات المستهدفة الأخرى.

**parameters**: معاملات هذه الوظيفة.
· `srs`: قائمة تحتوي على كائنات تمثل المنتديات (Subreddits) التي نريد البحث عن الحملات الإعلانية المرتبطة بها.
· `start`: تاريخ البداية للنطاق الزمني المطلوب البحث فيه.
· `end`: تاريخ النهاية للنطاق الزمني المطلوب البحث فيه.
· `ignore`: (اختياري) كائن يمثل حملة إعلانية معينة نريد تجاهلها في النتائج.

**Code Description**: 
تقوم هذه الوظيفة بالخطوات التالية:
1. تحويل `srs` إلى مجموعة من أسماء المنتديات (Subreddits) باستخدام `sr.name`.
2. استرداد الحملات الإعلانية المرتبطة بالمنتديات المحددة والنطاق الزمني باستخدام `get_campaigns_by_date`.
3. جمع جميع الحملات الإعلانية المستردة في مجموعة واحدة.
4. استخراج أسماء المنتديات المستهدفة من الحملات الإعلانية المستردة.
5. إذا كانت هناك منتديات جديدة لم يتم البحث عنها من قبل، يتم استرداد الحملات الإعلانية المرتبطة بها وتكرار العملية حتى لا توجد منتديات جديدة.
6. إرجاع جميع الحملات الإعلانية التي تم العثور عليها.

**العلاقة مع الوظائف الأخرى**:
- تستدعي هذه الوظيفة `get_campaigns_by_date` لاسترداد الحملات الإعلانية المرتبطة بمنتديات محددة وتوسيع البحث ليشمل المنتديات المستهدفة الأخرى.
- يتم استدعاء هذه الوظيفة من قبل `get_available_pageviews` لاسترداد جميع الحملات الإعلانية المرتبطة بالمنتديات المحددة وتحديد الصفحات المتاحة.

**Note**:
- يجب أن تكون التواريخ المقدمة في `start` و `end` بتنسيق متوافق مع `to_date`.
- الحملات الإعلانية التي يتم تجاهلها في `ignore` لن يتم تضمينها في النتائج.

**Output Example**:
```python
{
    <PromoCampaign object 1>,
    <PromoCampaign object 2>,
    <PromoCampaign object 3>,
    ...
}
```
## FunctionDef get_available_pageviews(targets, start, end, location, datestr, ignore, platform)
**get_available_pageviews**: وظيفة `get_available_pageviews` هي حساب عدد الصفحات المتاحة للعرض (pageviews) بناءً على الأهداف والموقع الجغرافي المحدد خلال فترة زمنية معينة.

**parameters**: معاملات هذه الوظيفة.
· `targets`: قائمة تحتوي على كائنات تمثل الأهداف (Targets) التي نريد حساب الصفحات المتاحة لها. يمكن أن تكون هذه الأهداف عبارة عن منتديات (Subreddits) أو مجموعات من المنتديات.
· `start`: تاريخ البداية للنطاق الزمني المطلوب حساب الصفحات المتاحة فيه.
· `end`: تاريخ النهاية للنطاق الزمني المطلوب حساب الصفحات المتاحة فيه.
· `location`: (اختياري) كائن من نوع `Location` يمثل الموقع الجغرافي المستهدف. إذا لم يتم تحديده، يتم افتراض أن الحساب غير مستهدف جغرافيًا.
· `datestr`: (اختياري) قيمة منطقية تحدد ما إذا كان سيتم إرجاع التواريخ كسلاسل نصية (strings) أو ككائنات `datetime`. القيمة الافتراضية هي `False`.
· `ignore`: (اختياري) كائن يمثل حملة إعلانية معينة نريد تجاهلها في الحساب.
· `platform`: (اختياري) سلسلة نصية تحدد النظام الأساسي المستهدف (مثل 'mobile' أو 'desktop'). القيمة الافتراضية هي 'all'.

**Code Description**: 
تقوم هذه الوظيفة بحساب عدد الصفحات المتاحة للعرض (pageviews) بناءً على الأهداف والموقع الجغرافي المحدد خلال فترة زمنية معينة. يتم ذلك من خلال الخطوات التالية:

1. **تجميع مستويات التحديد الجغرافي**: يتم تجميع مستويات التحديد الجغرافي بناءً على الموقع المحدد. إذا تم تحديد موقع جغرافي، يتم إضافة المستويات الأعلى منه (مثل الدولة والمدينة) إلى القائمة.

2. **استرداد الحملات الإعلانية**: يتم استرداد جميع الحملات الإعلانية المرتبطة بالأهداف المحددة خلال الفترة الزمنية المحددة باستخدام وظيفة `find_campaigns`. يتم أيضًا تجاهل الحملات الإعلانية المحددة في معامل `ignore`.

3. **حساب الصفحات المتوقعة**: يتم حساب الصفحات المتوقعة لكل منتدى (Subreddit) وموقع جغرافي باستخدام وظيفة `get_predicted_pageviews`.

4. **حساب الصفحات المحجوزة**: يتم حساب الصفحات المحجوزة (booked impressions) لكل هدف وموقع جغرافي لكل يوم في الفترة الزمنية المحددة.

5. **حساب الصفحات المتاحة**: يتم حساب الصفحات المتاحة لكل هدف وموقع جغرافي على كل يوم. يتم تحديد الصفحات المتاحة كأقل قيمة من الصفحات المتوقعة عبر جميع مستويات التحديد الجغرافي.

6. **تعديل الصفحات المتاحة بناءً على النظام الأساسي**: إذا تم تحديد نظام أساسي معين (مثل 'mobile' أو 'desktop')، يتم تعديل الصفحات المتاحة بناءً على النسبة المحددة للصفحات على النظام الأساسي.

7. **إرجاع النتائج**: يتم إرجاع النتائج كقاموس يحتوي على الصفحات المتاحة لكل هدف وتاريخ. إذا تم تمرير هدف واحد فقط، يتم إرجاع القيم مباشرة.

**العلاقة مع الوظائف الأخرى**:
- تستدعي هذه الوظيفة `find_campaigns` لاسترداد الحملات الإعلانية المرتبطة بالأهداف المحددة.
- تستدعي هذه الوظيفة `get_predicted_pageviews` لحساب الصفحات المتوقعة لكل منتدى وموقع جغرافي.
- يتم استدعاء هذه الوظيفة من قبل `get_oversold` لتحديد الأيام التي تكون فيها الصفحات المتاحة أقل من الطلب اليومي.

**Note**:
- يجب أن تكون التواريخ المقدمة في `start` و `end` بتنسيق متوافق مع `to_date`.
- إذا تم تحديد موقع جغرافي، يتم حساب الصفحات المتاحة بناءً على جميع مستويات التحديد الجغرافي.

**Output Example**:
إذا تم تمرير هدف واحد مثل `Target(subreddit_names=["funny"])` وفترة زمنية من '2023-10-01' إلى '2023-10-03'، قد يكون الإخراج كالتالي:
```python
{
    "2023-10-01": 10000,
    "2023-10-02": 9500,
    "2023-10-03": 10500
}
```
إذا تم تمرير قائمة أهداف مثل `[Target(subreddit_names=["funny"]), Target(subreddit_names=["news"])]`، قد يكون الإخراج كالتالي:
```python
{
    "funny": {
        "2023-10-01": 10000,
        "2023-10-02": 9500,
        "2023-10-03": 10500
    },
    "news": {
        "2023-10-01": 8000,
        "2023-10-02": 7500,
        "2023-10-03": 8500
    }
}
```
## FunctionDef get_oversold(target, start, end, daily_request, ignore, location)
**get_oversold**: وظيفة `get_oversold` هي تحديد الأيام التي تكون فيها الصفحات المتاحة أقل من الطلب اليومي المحدد خلال فترة زمنية معينة.

**parameters**: معاملات هذه الوظيفة.
· `target`: الهدف الذي نريد التحقق من توفر الصفحات له. يمكن أن يكون هذا الهدف عبارة عن منتدى (Subreddit) أو مجموعة من المنتديات.
· `start`: تاريخ البداية للنطاق الزمني المطلوب التحقق منه.
· `end`: تاريخ النهاية للنطاق الزمني المطلوب التحقق منه.
· `daily_request`: عدد الصفحات المطلوبة يوميًا للهدف المحدد.
· `ignore`: (اختياري) كائن يمثل حملة إعلانية معينة نريد تجاهلها في الحساب.
· `location`: (اختياري) كائن من نوع `Location` يمثل الموقع الجغرافي المستهدف. إذا لم يتم تحديده، يتم افتراض أن الحساب غير مستهدف جغرافيًا.

**Code Description**: 
تقوم هذه الوظيفة بحساب الأيام التي تكون فيها الصفحات المتاحة أقل من الطلب اليومي المحدد. يتم ذلك من خلال الخطوات التالية:

1. **استرداد الصفحات المتاحة**: يتم استرداد الصفحات المتاحة لكل يوم في الفترة الزمنية المحددة باستخدام وظيفة `get_available_pageviews`. يتم تمرير الهدف (`target`)، وتواريخ البداية والنهاية (`start` و `end`)، والموقع الجغرافي (`location`)، وأي حملات إعلانية نريد تجاهلها (`ignore`) إلى هذه الوظيفة.

2. **مقارنة الصفحات المتاحة مع الطلب اليومي**: يتم مقارنة الصفحات المتاحة لكل يوم مع الطلب اليومي (`daily_request`). إذا كانت الصفحات المتاحة أقل من الطلب اليومي، يتم تسجيل هذا اليوم وقيمة الصفحات المتاحة في قاموس `oversold`.

3. **إرجاع النتائج**: يتم إرجاع قاموس `oversold` الذي يحتوي على الأيام التي تكون فيها الصفحات المتاحة أقل من الطلب اليومي وقيمة الصفحات المتاحة لكل يوم.

**العلاقة مع الوظائف الأخرى**:
- تستدعي هذه الوظيفة `get_available_pageviews` لاسترداد الصفحات المتاحة لكل يوم في الفترة الزمنية المحددة.
- يتم استدعاء هذه الوظيفة من قبل وحدات أخرى في النظام لتحديد الأيام التي تكون فيها الصفحات المتاحة أقل من الطلب اليومي.

**Note**:
- يجب أن تكون التواريخ المقدمة في `start` و `end` بتنسيق متوافق مع `to_date`.
- إذا تم تحديد موقع جغرافي، يتم حساب الصفحات المتاحة بناءً على جميع مستويات التحديد الجغرافي.

**Output Example**:
إذا تم تمرير هدف مثل `Target(subreddit_names=["funny"])`، وفترة زمنية من '2023-10-01' إلى '2023-10-03'، وطلب يومي قدره 10000 صفحة، قد يكون الإخراج كالتالي:
```python
{
    "2023-10-02": 9500,
    "2023-10-03": 9800
}
```
هذا يعني أن الصفحات المتاحة في يومي '2023-10-02' و '2023-10-03' كانت أقل من الطلب اليومي المحدد.
</div>
